<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colorado Remediation Projects Map</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@200;400;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Colorado Remediation Projects</h1>
        <p class="chatter">Chatter text goes here - add your descriptive text about the visualization</p>
        <div id="map"></div>
        <div class="footer">
            <span class="source">Source: Colorado Oil and Gas Conservation Commission</span>
            <a href="https://coloradosun.com" class="logo">
                <img src="https://i0.wp.com/newspack-coloradosun.s3.amazonaws.com/wp-content/uploads/2024/11/cropped-black-text-transparent-bg.png" alt="Colorado Sun Logo">
            </a>
        </div>
    </div>
    
    <script>
        const map = L.map('map');
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd'
        }).addTo(map);
        
        const countyStyle = feature => ({
            color: feature.properties.name === 'Weld' ? '#000' : '#666',
            weight: feature.properties.name === 'Weld' ? 3 : 2,
            opacity: 0.8,
            fillOpacity: feature.properties.name === 'Weld' ? 0 : 0.1,
            interactive: false
        });
        
        const siteStyles = {
            active: {
                radius: 5,
                color: '#000',
                weight: 2,
                fillColor: '#2563eb',
                fillOpacity: 0.9
            },
            closed: {
                radius: 5,
                color: '#000',
                weight: 2,
                fillColor: '#fff',
                fillOpacity: 0.7
            }
        };
        
        fetch('data/colorado-counties.json')
        .then(response => response.json())
        .then(counties => {
            L.geoJSON(counties, {
                style: countyStyle
            }).addTo(map);
            
            counties.features.forEach(county => {
                const bounds = L.geoJSON(county).getBounds();
                const center = turf.centerOfMass(county).geometry.coordinates;
                
                const label = L.marker([center[1], center[0]], {
                    icon: L.divIcon({
                        className: 'county-label',
                        html: `<div>${county.properties.name}</div>`,
                        iconSize: [120, 20],
                        iconAnchor: [60, 10]
                    })
                }).addTo(map);
                
                map.on('zoomend', () => {
                    const countyPixelBounds = bounds.toBBoxString().split(',').map(Number);
                    const width = Math.abs(countyPixelBounds[2] - countyPixelBounds[0]);
                    const height = Math.abs(countyPixelBounds[3] - countyPixelBounds[1]);
                    label.getElement().style.display = width < 100 || height < 50 ? 'none' : 'block';
                });
            });
        });
        
        fetch('data/remediation_projects.json')
        .then(response => response.json())
        .then(data => {
            const bounds = L.latLngBounds();
            
            data.forEach(site => {
                if (site.Lattitude && site.Longitude) {
                    const marker = L.circleMarker(
                        [site.Lattitude, site.Longitude],
                        siteStyles[site.ProjectStatus.toLowerCase()]
                    ).addTo(map);
                    
                    bounds.extend([site.Lattitude, site.Longitude]);
                    
                    marker.bindPopup(`
                        <div class="popup-content">
                            <h3>${site["Site\nName"] || "Unnamed Site"}</h3>
                            <p><strong>Status:</strong> ${site.ProjectStatus}</p>
                            <p><strong>Operator:</strong> ${site.Operator}</p>
                            <p><strong>Municipality:</strong> ${site.Municipality}</p>
                            <p><strong>Date Opened:</strong> ${site["Date\nOpened"]}</p>
                            ${site["Date\nClosed"] ? `<p><strong>Date Closed:</strong> ${site["Date\nClosed"]}</p>` : ''}
                        </div>
                    `);
                    
                    marker.on('mouseover', function(e) {
                        this.openPopup();
                    });
                }
            });
            
            map.fitBounds(bounds, { padding: [20, 20] });
        });
        
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>Site Status</h4>
                <div class="legend-item">
                    <span class="legend-marker active"></span>
                    Active
                </div>
                <div class="legend-item">
                    <span class="legend-marker closed"></span>
                    Closed
                </div>
            `;
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>